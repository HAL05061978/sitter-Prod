(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[48],{3402:function(e,t,s){Promise.resolve().then(s.bind(s,4176))},4176:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return c}});var a=s(7437),i=s(2265),r=s(9376),n=s(3519),d=s(3521),l=s(7506);function c(){let e=(0,r.useRouter)(),{t}=(0,l.$G)(),[s,c]=(0,i.useState)(!0),[o,m]=(0,i.useState)(null),[u,x]=(0,i.useState)([]),[g,h]=(0,i.useState)(null),[p,f]=(0,i.useState)([]),[b,w]=(0,i.useState)(""),[v,_]=(0,i.useState)({}),[y,j]=(0,i.useState)(!1),[N,S]=(0,i.useState)(new Set),[E,O]=(0,i.useState)({}),C=(0,i.useRef)(null);(0,i.useEffect)(()=>{C.current&&C.current.scrollIntoView({behavior:"smooth"})},[p]),(0,i.useEffect)(()=>{n.O.auth.getUser().then(async t=>{let{data:s}=t;s.user?(m(s.user),await k(s.user.id),c(!1)):e.replace("/auth")})},[e]),(0,i.useEffect)(()=>{let e=()=>{!document.hidden&&o&&(q(o.id,u),window.dispatchEvent(new CustomEvent("messagesViewed")))};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[o,u]),(0,i.useEffect)(()=>{if(!o||0===u.length)return;let e=u.map(e=>e.id),t=n.O.channel("chat_unread_updates").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:"group_id=in.(".concat(e.join(","),")")},e=>{let t=e.new;t.sender_id!==(null==o?void 0:o.id)&&(S(e=>{let s=new Set(e);return s.add(t.group_id),s}),O(e=>({...e,[t.group_id]:(e[t.group_id]||0)+1})))}).subscribe();return()=>{t.unsubscribe()}},[o,u]);let k=async e=>{let{data:t}=await n.O.from("groups").select("*").eq("created_by",e).order("created_at",{ascending:!1}),{data:s}=await n.O.from("group_members").select("group_id, status").eq("profile_id",e).eq("status","active"),a=[];s&&(a=s.map(e=>e.group_id));let{data:i}=await n.O.from("groups").select("*").in("id",a).order("created_at",{ascending:!1}),r=[...t||[],...i||[]].filter((e,t,s)=>t===s.findIndex(t=>t.id===e.id));x(r),await q(e,r)},q=async(e,t)=>{try{let s=t.map(e=>e.id),{data:a}=await n.O.from("chat_messages").select("id, group_id").in("group_id",s).neq("sender_id",e);if(!a||0===a.length){S(new Set);return}let i=a.map(e=>e.id),{data:r}=await n.O.from("message_views").select("message_id").eq("user_id",e).in("message_id",i),d=new Set((r||[]).map(e=>e.message_id)),l={};a.forEach(e=>{d.has(e.id)||(l[e.group_id]=(l[e.group_id]||0)+1)});let c=new Set(Object.keys(l).filter(e=>l[e]>0));S(c),O(l)}catch(e){}},T=async e=>{let{data:t,error:s}=await n.O.from("chat_messages").select("*").eq("group_id",e).order("created_at",{ascending:!0});if(s)return;f(t||[]);let a=Array.from(new Set((t||[]).map(e=>e.sender_id)));if(a.length>0){let{data:e}=await n.O.from("profiles").select("id, full_name, email").in("id",a),t={};(e||[]).forEach(e=>{t[e.id]=e}),_(t)}},D=async e=>{if(e.preventDefault(),!g||!b.trim()||!o)return;j(!0);let{error:t}=await n.O.from("chat_messages").insert([{group_id:g.id,sender_id:o.id,content:b.trim()}]);t?alert("Failed to send message. Please try again."):(w(""),await T(g.id)),j(!1)},I=async e=>{if((null==g?void 0:g.id)===e.id){h(null),f([]);return}h(e),await T(e.id),o&&await L(e.id,o.id),S(t=>{let s=new Set(t);return s.delete(e.id),s}),O(t=>{let s={...t};return delete s[e.id],s});let t=n.O.channel("chat:".concat(e.id)).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages",filter:"group_id=eq.".concat(e.id)},e=>{let t=e.new;f(e=>[...e,t]),v[t.sender_id]||n.O.from("profiles").select("id, full_name, email").eq("id",t.sender_id).single().then(e=>{let{data:t}=e;t&&_(e=>({...e,[t.id]:t}))})}).subscribe();return()=>{t.unsubscribe()}},L=async(e,t)=>{try{let{data:s}=await n.O.from("chat_messages").select("id").eq("group_id",e).neq("sender_id",t);if(!s||0===s.length)return;let a=s.map(e=>e.id).map(e=>({user_id:t,message_id:e})),{error:i}=await n.O.from("message_views").upsert(a,{onConflict:"user_id,message_id",ignoreDuplicates:!0});i?(console.error("Error marking messages as viewed:",i),"23503"===i.code&&(console.error("Foreign key constraint violation - message_views table may need to be fixed"),setTimeout(()=>{window.dispatchEvent(new CustomEvent("messagesViewed"))},100))):setTimeout(()=>{window.dispatchEvent(new CustomEvent("messagesViewed"))},100)}catch(e){console.error("Error marking messages as viewed:",e)}};return s?(0,a.jsx)("div",{className:"flex min-h-screen items-center justify-center",children:"Loading..."}):(0,a.jsx)(d.Z,{currentPage:"chats",children:(0,a.jsxs)("div",{className:"bg-white",children:[(0,a.jsx)("div",{className:"max-w-7xl mx-auto px-3 sm:px-4 md:px-6 py-6",children:(0,a.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6 mb-6",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"Your Groups"}),0===u.length?(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,a.jsx)("p",{children:"No groups available."}),(0,a.jsx)("p",{className:"text-sm",children:"Join or create a group to start chatting."})]}):(0,a.jsx)("div",{className:"space-y-3",children:u.map(e=>{let t=N.has(e.id),s=E[e.id]||0,i=(null==g?void 0:g.id)===e.id;return(0,a.jsxs)("div",{children:[(0,a.jsx)("button",{onClick:()=>I(e),className:"w-full p-4 rounded-lg border-2 transition-colors text-left ".concat(i?"border-blue-500 bg-blue-50":t?"border-orange-400 bg-orange-50 shadow-md":"border-gray-200 hover:border-blue-300 hover:bg-gray-50"),children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"font-semibold text-lg mb-2",children:e.name}),e.description&&(0,a.jsx)("p",{className:"text-gray-600 text-sm mb-2",children:e.description}),(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[(0,a.jsx)("span",{children:e.created_by===(null==o?void 0:o.id)?"Creator":"Member"}),(0,a.jsx)("span",{children:new Date(e.created_at).toLocaleDateString()})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[t&&(0,a.jsx)("span",{className:"bg-orange-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center font-bold",children:s>99?"99+":s}),(0,a.jsx)("span",{className:"text-xs transition-transform ".concat(i?"rotate-180":""),children:"â–¼"})]})]})}),i&&(0,a.jsx)("div",{className:"mt-2 ml-4 p-2 bg-blue-50 rounded text-sm text-blue-600 font-medium",children:"Chat active - scroll down to see other groups"})]},e.id)})})]})}),g&&(0,a.jsx)("div",{className:"fixed left-0 right-0 bg-white shadow-2xl",style:{top:"145px",bottom:"90px",zIndex:9999},children:(0,a.jsxs)("div",{className:"h-full flex flex-col",children:[(0,a.jsxs)("div",{className:"px-3 sm:px-4 md:px-6 py-3 border-b border-gray-200 bg-gray-50 flex justify-between items-center",children:[(0,a.jsxs)("h3",{className:"text-base sm:text-lg font-semibold text-gray-900",children:["Chat: ",g.name]}),(0,a.jsx)("button",{onClick:()=>h(null),className:"text-gray-500 hover:text-gray-700 text-sm font-medium",children:"Minimize"})]}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto px-3 sm:px-4 md:px-6 py-4 bg-gray-50",children:0===p.length?(0,a.jsxs)("div",{className:"text-center text-gray-500 py-8",children:[(0,a.jsx)("p",{children:"No messages yet."}),(0,a.jsx)("p",{className:"text-sm",children:"Start the conversation!"})]}):(0,a.jsxs)("div",{className:"space-y-3",children:[p.map(e=>{let t=e.sender_id===(null==o?void 0:o.id),s=v[e.sender_id],i=(null==s?void 0:s.full_name)||(null==s?void 0:s.email)||"Unknown";return(0,a.jsx)("div",{className:"flex ".concat(t?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"max-w-xs lg:max-w-md px-4 py-2 rounded-lg ".concat(t?"bg-blue-500 text-white":"bg-white border border-gray-200"),children:[(0,a.jsx)("div",{className:"text-xs opacity-75 mb-1",children:t?"You":i}),(0,a.jsx)("div",{className:"text-sm",children:e.content}),(0,a.jsx)("div",{className:"text-xs opacity-75 mt-1",children:new Date(e.created_at).toLocaleTimeString()})]})},e.id)}),(0,a.jsx)("div",{ref:C})]})}),(0,a.jsx)("div",{className:"px-3 sm:px-4 md:px-6 py-3 border-t border-gray-200 bg-white",children:(0,a.jsxs)("form",{onSubmit:D,className:"flex gap-2",children:[(0,a.jsx)("input",{type:"text",value:b,onChange:e=>w(e.target.value),placeholder:"Type your message...",className:"flex-1 px-3 sm:px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base",style:{fontSize:"16px"},disabled:y}),(0,a.jsx)("button",{type:"submit",disabled:y||!b.trim(),className:"px-4 sm:px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-base font-medium whitespace-nowrap",children:y?"Sending...":"Send"})]})})]})})]})})}}},function(e){e.O(0,[256,506,634,521,971,117,744],function(){return e(e.s=3402)}),_N_E=e.O()}]);